<?php
/**
 * Hyvä Themes - https://hyva.io
 * Copyright © Hyvä Themes 2020-present. All rights reserved.
 * This product is licensed per Magento install
 * See https://hyva.io/license
 */

declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\HeroiconsSolid;
use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;
use Magento\Swatches\ViewModel\Product\Renderer\Configurable as ConfigurableViewModel;

// phpcs:disable Generic.Files.LineLength.TooLong

/** @var Template $block */
/** @var Escaper $escaper */
/** @var ViewModelRegistry $viewModels */

/** @var ConfigurableViewModel $configurableViewModel */
$configurableViewModel = $viewModels->require(ConfigurableViewModel::class);

/** @var HeroiconsSolid $heroiconsSolid */
$heroiconsSolid = $viewModels->require(HeroiconsSolid::class);

$productId = $block->getProductId();
$attributeId = $block->getAttributeId();

if (!$productId || !$attributeId) {
    return '';
}

$swatchClasses = "swatch-option bg-white flex justify-center text-slate-800 font-medium transition outline-none";

$textSwatchClasses = "type-text py-2 px-2.5 !border-2 rounded-md border-slate-200 text-sm font-medium" // standard
    . " hover:border-blue-300 focus-within:border-blue-300" // hover - focus
    . " data-[checked]:focus-within:border-blue-400 data-[checked]:focus-within:ring data-[checked]:focus-within:ring-blue-100" // focus+selected
    . " data-[checked]:border-blue-500 [&[data-checked]:not(:focus-within)]:bg-blue-50 data-[checked]:text-blue-800" // selected
    . " active:border-blue-500"; // active

$colorSwatchClasses = "type-color w-8 h-8 !mr-2 !min-w-0 rounded-full !border-0" // standard
    . " shadow-[inset_0_0_0_1px_rgba(0,0,0,0.32)]" // border
    . " hover:ring-2 hover:ring-blue-300 [&:hover:not([data-checked])]:ring-offset-2" // hover
    . " focus-within:ring-2 focus-within:ring-blue-300 [&:focus-within:not([data-checked])]:ring-offset-2" // focus
    . " data-[checked]:focus-within:ring-2 data-[checked]:focus-within:ring-blue-500 data-[checked]:focus-within:ring-offset-2 data-[checked]:focus-within:ring-offset-blue-200" // focus+selected
    . " data-[checked]:ring-2 data-[checked]:ring-blue-500 [&[data-checked]:not(:focus-within)]:ring-offset-2" // selected
    . " active:ring-2 active:ring-blue-500 [&:active:not([data-checked])]:ring-offset-2"; // active

$imageSwatchClasses = "type-image w-8 h-8 !mr-2 border-slate-200 !p-0 rounded-md aspect-square !border-2 !min-w-0" // standard
    . " focus-within:ring-2 focus-within:ring-blue-300 [&:focus-within:not([data-checked])]:ring-offset-2" // focus
    . " hover:ring-2 hover:ring-blue-300 [&:hover:not([data-checked])]:ring-offset-2" // hover
    . " data-[checked]:focus-within:ring-2 data-[checked]:focus-within:ring-blue-500 data-[checked]:focus-within:ring-offset-2 data-[checked]:focus-within:ring-offset-blue-200" // focus+selected
    . " data-[checked]:ring-2 data-[checked]:ring-blue-500 [&[data-checked]:not(:focus-within)]:ring-offset-2" // selected
    . " active:ring-2 active:ring-blue-500 [&:active:not([data-checked])]:ring-offset-2"; // active
?>

<div x-id="['attribute-option-<?= (int) $productId ?>-'+item.id]">
    <template x-if="optionIsEnabled(<?= (int) $attributeId ?>, item.id) && optionIsActive(<?= (int) $attributeId ?>, item.id)">
        <label
            :for="$id('attribute-option-<?= (int) $productId ?>-'+item.id)"
            class="relative cursor-pointer <?= $swatchClasses ?>"
            :class="{
                '<?= $textSwatchClasses ?>': getSwatchType(<?= (int) $attributeId ?>, item.id) === 'text',
                '<?= $colorSwatchClasses ?>': getSwatchType(<?= (int) $attributeId ?>, item.id) === 'color',
                '<?= $imageSwatchClasses ?>': getSwatchType(<?= (int) $attributeId ?>, item.id) === 'image'
            }"
            :style="getSwatchBackgroundStyle('<?= (int) $attributeId ?>',item.id)"
            :data-checked="selectedValues[<?= (int)$attributeId ?>] === item.id"
            <?php /* The dummy touchstart event listener prevents mobile safari from requiring a double tap to select swatches */ ?>
            @touchstart=""
            <?php if ($configurableViewModel->getShowSwatchTooltip()): ?>
                @mouseenter.self="activeTooltipItem = {
                    attribute: '<?= (int) $attributeId ?>',
                    item: item.id,
                    index
                }; tooltipPositionElement = $event.target;"
                @mouseleave.self="activeTooltipItem = false"
            <?php endif; ?>
        >
            <input
                :id="$id('attribute-option-<?= (int) $productId ?>-'+item.id)"
                :value="item.id"
                name="super_attribute[<?= (int) $attributeId ?>]"
                type="radio"
                class="inline-block absolute p-0 border-0 focus:border-0 focus:ring-0 product-option-value-input"
                style="z-index:-1"
                @focus="focusLabel(item.id)"
                @blur="blurLabel()"
                @change="changeOption(<?= (int) $attributeId ?>, $event.target.value)"
                @click="clearOptionIfActive(<?= (int) $attributeId ?>, item.id)"
                x-model="selectedValues[<?= (int) $attributeId ?>]"
                :required="getAllowedAttributeOptions(<?= (int) $attributeId ?>).filter(
                    attributeOption => selectedValues[attributeOption]
                ).length === 0"
                :aria-label="getSwatchText(<?= $escaper->escapeHtmlAttr($attributeId) ?>, item.id)"
                aria-describedby="attribute-label-<?= $escaper->escapeHtmlAttr($productId . '-' . $attributeId) ?>"
            >
            <template x-if="isTextSwatch(<?= (int) $attributeId ?>, item.id)">
                <div
                    x-html="getSwatchText(<?= (int) $attributeId ?>, item.id)"
                    class="pointer-events-none select-none whitespace-nowrap"
                    aria-hidden="true"
                ></div>
            </template>
        </label>
    </template>

    <template x-if="optionIsEnabled(<?= (int) $attributeId ?>, item.id) && !optionIsActive(<?= (int) $attributeId ?>, item.id)">
        <div
            class="relative cursor-not-allowed <?= $swatchClasses ?>"
            :class="{
                '<?= $textSwatchClasses ?> opacity-75': isTextSwatch(<?= (int) $attributeId ?>, item.id),
                '<?= $colorSwatchClasses ?> opacity-50': getSwatchType(<?= (int) $attributeId ?>, item.id) === 'color',
                '<?= $imageSwatchClasses ?> opacity-50': getSwatchType(<?= (int) $attributeId ?>, item.id) === 'image'
            }"
            :style="getSwatchBackgroundStyle('<?= (int) $attributeId ?>',item.id)"
            data-disabled
        >
            <div
                x-show="isTextSwatch(<?= (int) $attributeId ?>, item.id)"
                x-html="getSwatchText(<?= (int) $attributeId ?>, item.id)"
                class="pointer-events-none select-none whitespace-nowrap"
                aria-hidden="true"
            ></div>
            <div class="absolute inset-0 flex justify-center items-center rounded-[inherit]">
                <template x-if="isTextSwatch(<?= (int) $attributeId ?>, item.id)">
                    <svg viewbox="0 0 24 24" width="24" height="24" class="w-full h-full">
                        <line x1="0" y1="100%" x2="100%" y2="0" stroke="currentColor" stroke-width="1"></line>
                    </svg>
                </template>
                <template x-if="!isTextSwatch(<?= (int) $attributeId ?>, item.id)">
                    <?= $heroiconsSolid->xHtml('shrink-0 rounded-[inherit] p-0.5 bg-white text-red-600', 20, 20)?>
                </template>
            </div>
        </div>
    </template>
</div>
